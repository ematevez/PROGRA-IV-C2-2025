<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chat Bot Telegram</title>
<style>
.chat-container { max-width: 700px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; }
.chat-box { max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px; background: #fafafa; }
.message { margin-bottom: 12px; }
.message strong { color: #333; }
.me { text-align: right; }
img, audio { margin-top: 5px; border-radius: 8px; max-width: 80%; }
form { display: flex; flex-direction: column; gap: 10px; }
button { padding: 8px; border-radius: 6px; border: none; background: #0078d7; color: white; cursor: pointer; }
</style>
</head>
<body>
<div class="chat-container">
    <h2>üí¨ Chat con Bot</h2>

    <div class="chat-box"></div>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="text" name="message" placeholder="Escrib√≠ tu mensaje...">
        <label>üì∏ Imagen: <input type="file" name="photo" accept="image/*"></label>
        <label>üéß Audio: <input type="file" name="audio" accept="audio/*"></label>
        <button type="submit">Enviar</button>
    </form>

    <button id="recordBtn">üé§ Grabar Audio</button>
    <audio id="preview" controls></audio>
</div>

<script>
const chatBox = document.querySelector('.chat-box');

// --- Funci√≥n para traer mensajes ---
async function fetchMessages() {
    const response = await fetch(window.location.href, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    const data = await response.json();
    chatBox.innerHTML = '';

    data.messages.forEach(msg => {
        const div = document.createElement('div');
        div.classList.add('message');
        if(msg.sender === 'T√∫') div.classList.add('me');

        let content = `<strong>${msg.sender}:</strong>`;
        if(msg.text) content += `<p>${msg.text}</p>`;
        if(msg.photo) content += `<img src="${msg.photo}" alt="Imagen">`;
        if(msg.audio) content += `<audio controls><source src="${msg.audio}" type="audio/mpeg"></audio>`;
        div.innerHTML = content;
        chatBox.appendChild(div);
    });

    chatBox.scrollTop = chatBox.scrollHeight;
}

// Actualiza cada 3 segundos
setInterval(fetchMessages, 3000);
fetchMessages();

// --- Grabaci√≥n de audio desde micr√≥fono ---
let recordBtn = document.getElementById('recordBtn');
let preview = document.getElementById('preview');
let mediaRecorder;
let audioChunks = [];

recordBtn.onclick = async () => {
    if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = e => {
            const blob = new Blob(audioChunks, { type: 'audio/mpeg' });
            preview.src = URL.createObjectURL(blob);

            const file = new File([blob], "recorded_audio.mp3", { type: "audio/mpeg" });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            document.querySelector('input[name="audio"]').files = dataTransfer.files;
        };

        recordBtn.textContent = "‚èπ Detener grabaci√≥n";
    } else {
        mediaRecorder.stop();
        recordBtn.textContent = "üé§ Grabar Audio";
    }
};
</script>
</body>
</html>
